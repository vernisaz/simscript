# common script for building test cases

if {
	eq(${~os~},windows)
	then {
		assign(t_ext,.exe)
        }
        else {
             assign(t_ext,)
        }
}

cfg_test=test

target clippy_test:. {
   dependency{target(crate)}
   dependency {
       anynewer(${~script~},${test file}${t_ext})
   }
   dependency {
       anynewer(${~cwd~}/*.rs,${~cwd~}/${test file}${t_ext})
   }
   
   if {
   	   neq(test file,${test file})
   	   then{assign(tesf file,test)}
   }
   display(Clipping test ${test file} ...)
   exec clippy-driver::  (
       --color, always,
       -L,all=${crate_dir},
       comp opts,
       --edition, 2024,
       -Cpanic=abort,
       -o,
       clippy-test,
       ${~cwd~}${~/~}${test file}.rs
   )
     if {
         neq(~~, 0)
         then {
            panic("test clippy error(s)")
         }
     }
}

target build test:. {
   dependency{target(crate)}
   dependency {
       anynewer(${~script~},${test file}${t_ext})
   }
   dependency {
       anynewer(${~cwd~}/*.rs,${~cwd~}/${test file}${t_ext})
   }
   
   if {
   	   neq(test file,${test file})
   	   then{assign(tesf file,test)}
   }
   display(Compiling test ${test file} ...)
   exec rustc::  (
       --color, always,
       -L,all=${crate_dir},
       --extern, crate,
       --cfg, cfg_test,
       --edition, 2024,
       -o,
       test,
       ${~cwd~}${~/~}${test file}.rs
   )
     if {
         neq(~~, 0)
         then {
            panic("test compilation error(s)")
         }
     }
}

target run_test :.:Run test {
    dependency {
        target(build test)
    }
    dependency {true}
    ask(Would you like to run the test ? [Y|n] , Y)
    assign(answer, ~~)
    if {
        or{
            eq(answer,y)
            eq(answer,Y)
        }
        then {
            if {
            	neq(test,${test})
            	then {
            		assign(test,.${~/~}test${t_ext})
            	}
            }
            exec test (~args~)
        }
    }
}
